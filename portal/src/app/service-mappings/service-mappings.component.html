<ui5-dynamic-page>
  <ui5-dynamic-page-title slot="titleArea">
    <ui5-title slot="heading" level="H3">Service Mappings</ui5-title>

    <div slot="snappedHeading" class="snapped-heading">
      <ui5-avatar size="S" shape="Square" initials="SM" colorScheme="Accent5"></ui5-avatar>
      <div class="snapped-heading-text">
        <ui5-title level="H5">Service Mappings</ui5-title>
        <ui5-label>API Bindings & Export Requests</ui5-label>
      </div>
    </div>

    <ui5-label slot="subheading">Manage API bindings and create export requests for remote clusters</ui5-label>

    <ui5-toolbar slot="actionsBar" design="Transparent">
      <ui5-toolbar-button text="Refresh" design="Transparent" icon="refresh" (click)="loadData()"></ui5-toolbar-button>
    </ui5-toolbar>
  </ui5-dynamic-page-title>

  <ui5-dynamic-page-header slot="headerArea">
    <div class="header-content">
      <ui5-avatar size="XL" shape="Square" initials="SM" colorScheme="Accent5"></ui5-avatar>

      <div class="header-status-block">
        <div class="status-title">Available Services</div>
        <div class="object-number">
          <span class="number">{{ apiBindings().length }}</span>
        </div>
      </div>

      <div class="header-status-block">
        <div class="status-title">Export Requests</div>
        <div class="object-number">
          <span class="number">{{ exportRequests().length }}</span>
        </div>
      </div>
    </div>
  </ui5-dynamic-page-header>

  <div class="mappings-section">
    <!-- API Bindings Section -->
    <div class="section-header">
      <ui5-title level="H5">API Bindings</ui5-title>
      <ui5-label>Click on a binding to create an export request for remote clusters</ui5-label>
    </div>

    @if (loading()) {
      <div class="loading-state">
        <ui5-text>Loading API bindings...</ui5-text>
      </div>
    } @else if (apiBindings().length === 0) {
      <div class="empty-state">
        <ui5-icon name="share-2" class="empty-icon"></ui5-icon>
        <ui5-title level="H5">No API Bindings</ui5-title>
        <ui5-text>No API bindings are available for export.</ui5-text>
        <div class="help-text">
          <ui5-text>API bindings from kcp will appear here once they are created in the workspace.</ui5-text>
        </div>
      </div>
    } @else {
      <div class="mappings-grid">
        @for (ab of apiBindings(); track ab.metadata.name) {
          <div class="mapping-tile" [class]="getReadyClass(ab)" (click)="openExportDialog(ab)">
            <div class="tile-header">
              <ui5-avatar size="M" shape="Circle" initials="{{ getInitials(ab.metadata.name) }}"
                [colorScheme]="getColorScheme(ab.metadata.name)"></ui5-avatar>
              <div class="tile-title">
                <ui5-title level="H6">{{ ab.metadata.name }}</ui5-title>
                @if (ab.spec.reference?.export?.path) {
                  <ui5-label class="path-label">{{ ab.spec.reference?.export?.path }}</ui5-label>
                }
              </div>
              <ui5-button icon="add" design="Transparent" tooltip="Create Export Request"></ui5-button>
            </div>

            <div class="tile-content">
              <div class="tile-field">
                <ui5-label>Status</ui5-label>
                <div class="status-wrapper">
                  <ui5-icon [name]="getReadyIcon(ab)" class="status-icon" [class]="getReadyClass(ab)"></ui5-icon>
                  <span class="status-badge" [class]="getReadyClass(ab)">
                    {{ getReadyStatus(ab) }}
                  </span>
                </div>
              </div>
              @if (ab.status?.boundResources?.length) {
                <div class="tile-field resources-field">
                  <ui5-label>Bound Resources</ui5-label>
                  <div class="resources-list">
                    @for (resource of ab.status?.boundResources || []; track resource.group + '/' + resource.resource) {
                      <span class="resource-badge">{{ resource.resource }}.{{ resource.group }}</span>
                    }
                  </div>
                </div>
              }
              @if (ab.status?.phase) {
                <div class="tile-field">
                  <ui5-label>Phase</ui5-label>
                  <ui5-text>{{ ab.status?.phase }}</ui5-text>
                </div>
              }
            </div>

            <div class="tile-footer">
              <ui5-icon name="calendar" class="footer-icon"></ui5-icon>
              <ui5-label>{{ formatDate(ab.metadata.creationTimestamp) }}</ui5-label>
            </div>
          </div>
        }
      </div>
    }

    <!-- Export Requests Section -->
    <div class="section-header export-section">
      <ui5-title level="H5">Export Requests</ui5-title>
      <ui5-label>Active APIServiceExportRequests for remote cluster consumption</ui5-label>
    </div>

    @if (loadingExportRequests()) {
      <div class="loading-state">
        <ui5-text>Loading export requests...</ui5-text>
      </div>
    } @else if (exportRequests().length === 0) {
      <div class="empty-state small">
        <ui5-icon name="sys-minus" class="empty-icon small"></ui5-icon>
        <ui5-title level="H6">No Export Requests</ui5-title>
        <ui5-text>Click on an API binding above to create an export request.</ui5-text>
      </div>
    } @else {
      <div class="export-requests-grid">
        @for (req of exportRequests(); track req.metadata.name) {
          <div class="export-request-tile" [class]="getExportRequestClass(req)">
            <div class="tile-header">
              <ui5-avatar size="S" shape="Circle" initials="{{ getInitials(req.metadata.name) }}"
                [colorScheme]="getColorScheme(req.metadata.name)"></ui5-avatar>
              <div class="tile-title">
                <ui5-title level="H6">{{ req.metadata.name }}</ui5-title>
                <ui5-label class="namespace-label">{{ req.metadata.namespace || 'default' }}</ui5-label>
              </div>
              <ui5-button icon="delete" design="Transparent" tooltip="Delete Export Request" (click)="deleteExportRequest(req); $event.stopPropagation()"></ui5-button>
            </div>

            <div class="tile-content compact">
              <div class="tile-field">
                <ui5-label>Status</ui5-label>
                <span class="status-badge small" [class]="getExportRequestClass(req)">
                  {{ getExportRequestStatus(req) }}
                </span>
              </div>
              @if (getExportRequestStatusMessage(req)) {
                <div class="tile-field status-message-field">
                  <ui5-text class="status-message error">{{ getExportRequestStatusMessage(req) }}</ui5-text>
                </div>
              }
              @if (req.spec.resources?.length) {
                <div class="tile-field resources-field">
                  <ui5-label>Resources</ui5-label>
                  <div class="resources-list">
                    @for (resource of req.spec.resources || []; track resource.group + '/' + resource.resource) {
                      <span class="resource-badge small">{{ resource.resource }}.{{ resource.group }}</span>
                    }
                  </div>
                </div>
              }
              @if (req.spec.permissionClaims?.length) {
                <div class="tile-field resources-field">
                  <ui5-label>Permission Claims</ui5-label>
                  <div class="resources-list">
                    @for (claim of req.spec.permissionClaims || []; track claim.group + '/' + claim.resource) {
                      <span class="permission-badge small">{{ claim.resource }}{{ claim.group ? '.' + claim.group : '' }}</span>
                    }
                  </div>
                </div>
              }
            </div>

            <div class="tile-footer">
              <ui5-icon name="calendar" class="footer-icon"></ui5-icon>
              <ui5-label>{{ formatDate(req.metadata.creationTimestamp) }}</ui5-label>
            </div>
          </div>
        }
      </div>
    }
  </div>
</ui5-dynamic-page>

<!-- Create Export Request Dialog -->
<ui5-dialog
  header-text="Create Export Request"
  [open]="showExportDialog()"
  (close)="closeExportDialog()"
  class="export-dialog"
>
  <div class="dialog-content">
    @if (selectedAPIBinding()) {
      <div class="binding-info-header">
        <ui5-avatar size="M" shape="Circle" [initials]="getInitials(selectedAPIBinding()!.metadata.name)"
          [colorScheme]="getColorScheme(selectedAPIBinding()!.metadata.name)"></ui5-avatar>
        <div>
          <ui5-title level="H5">{{ selectedAPIBinding()!.metadata.name }}</ui5-title>
          <ui5-label>Source APIBinding</ui5-label>
        </div>
      </div>

      <!-- Resources to export -->
      <div class="form-section">
        <ui5-title level="H6">Resources to Export</ui5-title>
        @if (selectedAPIBinding()!.status?.boundResources?.length) {
          <div class="resources-preview">
            @for (resource of selectedAPIBinding()!.status?.boundResources || []; track resource.group + '/' + resource.resource) {
              <span class="resource-badge">{{ resource.resource }}.{{ resource.group }}</span>
            }
          </div>
        } @else {
          <ui5-text class="warning-text">No bound resources found in this APIBinding</ui5-text>
        }
      </div>

      <!-- Export request name -->
      <div class="form-section">
        <ui5-label for="exportName" required>Export Request Name</ui5-label>
        <ui5-input id="exportName" [value]="exportRequestName()" (input)="exportRequestName.set($any($event).target.value)" placeholder="e.g., cowboys"></ui5-input>
      </div>

      <!-- Target Namespace -->
      <div class="form-section">
        <ui5-label for="targetNamespace" required>Target Namespace</ui5-label>
        @if (getClusterBindingNamespaces().length === 0) {
          <ui5-text class="warning-text">No ClusterBinding namespaces available. Create a ClusterBinding first.</ui5-text>
        } @else {
          <ui5-select id="targetNamespace" (change)="onNamespaceChange($event)">
            @for (ns of getClusterBindingNamespaces(); track ns) {
              <ui5-option [value]="ns" [selected]="ns === selectedNamespace()">{{ ns }}</ui5-option>
            }
          </ui5-select>
        }
        <ui5-text class="help-text">Export requests must be created in a ClusterBinding namespace</ui5-text>
      </div>

      <!-- Permission Claims -->
      <div class="form-section">
        <ui5-title level="H6">Permission Claims (Optional)</ui5-title>
        <ui5-text class="help-text">Add permissions the exported service needs on the consumer cluster</ui5-text>

        @if (permissionClaims().length > 0) {
          <div class="permission-claims-list">
            @for (claim of permissionClaims(); track $index) {
              <div class="permission-claim-item">
                <span class="permission-badge">{{ claim.resource }}{{ claim.group ? '.' + claim.group : '' }}</span>
                <ui5-button icon="delete" design="Transparent" (click)="removePermissionClaim($index)"></ui5-button>
              </div>
            }
          </div>
        }

        <div class="add-permission-row">
          <ui5-input [value]="newPermissionGroup()" (input)="newPermissionGroup.set($any($event).target.value)" placeholder="Group (e.g., empty for core)"></ui5-input>
          <ui5-input [value]="newPermissionResource()" (input)="newPermissionResource.set($any($event).target.value)" placeholder="Resource (e.g., secrets)"></ui5-input>
          <ui5-button icon="add" design="Transparent" (click)="addPermissionClaim()">Add</ui5-button>
        </div>
      </div>
    }
  </div>

  <div slot="footer" class="dialog-footer">
    <ui5-button design="Transparent" (click)="closeExportDialog()">Cancel</ui5-button>
    <ui5-button design="Emphasized" (click)="createExportRequest()" [disabled]="!exportRequestName()">Create</ui5-button>
  </div>
</ui5-dialog>
